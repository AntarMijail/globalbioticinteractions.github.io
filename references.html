<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Global Biotic Interactions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="MHqp6kVCB-ILE2P_5iHK902nz8mCR0HwnqIgEFvwBgU"/>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="globi.css"/>
</head>
<body onload="init()">
<noscript>JavaScript is off. Please enable JavaScript to view full site.</noscript>
<div class="ui-widget">
    <div id="contributors">
        GloBI currently includes <span id="studies">(...)</span> <a href="http://api.globalbioticinteractions.org/reports/studies.tsv?limit=500000" title="list of references/studies, their sources and statistics">references</a> obtained from <span id="sources">(...)</span> <a href="http://api.globalbioticinteractions.org/reports/sources.tsv" title="list of sources and statistics">data sources</a>. In total,
        <span id="interactions">(...)</span> <a href="https://s3.amazonaws.com/globi/snapshot/target/data/taxa/interactions.csv.gz" title="csv file containing basic interaction records with resolved taxa, geospatial-temporal data, interaction types, and associated citations">interaction records</a> were discovered, covering <span id="distinctTaxa">(...)</span> <a href="https://s3.amazonaws.com/globi/snapshot/target/data/taxa/taxonCache.tsv.gz" title="list of taxa/terms (and associated rank, path, ids or thumbnails) that occur within GloBI">taxa</a>.
        A <a href="https://s3.amazonaws.com/globi/snapshot/target/data/taxa/taxonMap.tsv.gz" title="maps provided names/ids to existing taxonomies/terms">taxon map</a> shows how these taxa relate to other projects (e.g. <a href="http://ncbi.nlm.nih.gov/taxonomy" target="_blank">NCBI</a>, <a href="http://www.marinespecies.org" target="_blank">WoRMS</a>, <a href="http://eol.org" target="_blank">EOL</a>). Names that could not be linked are documented in the <a href="https://s3.amazonaws.com/globi/snapshot/target/data/taxa/taxonUnmatched.tsv" title="list of taxon names (and associated study/source) that did not match against any of the taxonomies integrated with GloBI. Includes taxon name suggestions.">list of unmatched taxon names by reference/source</a>. These unmatched or unresolved names are typically unknown or invalid names.
    </div>

    <p>Below, you can search for references that contain species interaction records. Example queries: <a href="?sourceTaxon=Enhydra%20lutris&interactionType=eats">Which references document sea otters (<em>Enhydra lutris</em>) prey?</a> or <a href="?sourceTaxon=Apis&interactionType=pollinates">Who documented what honey bees (Apis) pollinate?</a></p>
    <p>Which references containing <input id="studySearchField" autocomplete="off" placeholder="terms / doi"/> claim that
        <input id="taxonInputField" class="suggest" autocomplete="off" placeholder="some organism"/>
        <select id="interactionType">
            <option value="interactsWith">interact with</option>
            <option value="eats">eat</option>
            <option value="eatenBy">get eaten by</option>
            <option value="preysOn">preys on</option>
            <option value="preyedUponBy">get preyed on by</option>
            <option value="parasiteOf">parasitize</option>
            <option value="hasParasite">get parasitized by</option>
            <option value="visitsFlowersOf">visits flowers of</option>
            <option value="flowersVisitedBy">flowers visited by</option>
            <option value="pollinates">pollinate</option>
            <option value="pollinatedBy">get pollinated by</option>
            <option value="pathogenOf">infect</option>
            <option value="hasPathogen">get infected by</option>
            <option value="vectorOf">spread</option>
            <option value="hasVector">get spread by</option>
            <option value="kills">kill</option>
            <option value="killedBy">is killed by</option>
        </select>
        <input id="targetTaxonInputField" class="suggest" autocomplete="off" placeholder="some other organism"/>?
    </p>
    <div id="info"></div>
    <table id="result">
    </table>
</div>
<script src="menu.js"></script>
<script>
    buildMenu();
</script>

<script src="static/globi-web-min.js"></script>
<script>
    var $ = globiWeb.globi.jQuery;
    var globiData = globiWeb.globi.globiData;
    var offsetDefault = 0;
    var limitDefault = 1024;
</script>

<script src="links.js"></script>
<script src="query-string.js"></script>
<script>
    var className = function (someString) {
        return someString.replace(/\W/g, '_');
    }

    $(function () {
        var labelForTaxon = function (taxon) {
            var englishName;
            if (taxon.commonNames) {
                englishName = taxon.commonNames['en'];
            }
            var suggestion = taxon.scientificName;
            if (englishName !== undefined) {
                suggestion = englishName + ' (' + suggestion + ')';
            }
            return suggestion;
        };

        var searchForInteractions = function (offset) {
            $('thead, #moreButton').remove();
            if (!offset) {
                $('.interaction').remove();
            }
            var searchParams = collectSearchParams($);
            var search = searchParams.search;
            search.limit = limitDefault;
            search.offset = offset || offsetDefault;
            search.includeObservations = true;
            saveSearch(searchParams);
            var callback = function (interactions) {
                var resultFragment = document.createDocumentFragment();
                var distinctCitations = {};
                var nInteractions = 0;
                var nDistinctCitations = 0;
                if (interactions.length == 0) {
                    var row = resultFragment.appendChild(document.createElement('tr'));
                    row.setAttribute('class', 'interaction');
                    row.innerHTML = 'No references found. Bummer! Please change your search criteria or <a href="https://github.com/jhpoelen/eol-globi-data/wiki/How-to-Contribute-Data-to-Global-Biotic-Interactions%3F" target="_blank">contribute data</a>.'
                }

                interactions.forEach(function (interaction) {
                    var citationKey = encodeURIComponent(interaction.study_citation + interaction.study_source_citation);
                    nInteractions += 1;
                    if (document.getElementById(citationKey) === null && distinctCitations[citationKey] === undefined) {
                        var row = resultFragment.appendChild(document.createElement('tr'));
                        row.setAttribute('class', 'interaction');
                        row.setAttribute('id', citationKey);
                        appendCitationTo(interaction, row, '/index.html');
                        distinctCitations[citationKey] = interaction;
                        nDistinctCitations += 1;
                    }
                });

                if (nInteractions == limitDefault) {
                    var button = document.querySelector('#moreButton');
                    if (!button) {
                        button = document.createElement('button');
                        button.setAttribute('id', 'moreButton');
                        button.addEventListener('click', function (event) {
                            searchForInteractions(search.offset + limitDefault);
                        });
                        button.textContent = 'more...';
                    }
                    resultFragment.appendChild(button);
                }

                var result = document.getElementById('result');
                result.appendChild(resultFragment);
            };
            globiData.findSpeciesInteractions(search, callback);
        };

        $(".suggest").autocomplete({
            minLength: 3,
            source: function (request, response) {
                globiData.findCloseTaxonMatches(request.term, function (closeMatches) {
                    var suggestions = [];
                    closeMatches.forEach(function (closeMatch, index) {
                        suggestions[index] = {
                            label: labelForTaxon(closeMatch),
                            value: closeMatch.scientificName
                        };
                    });
                    response(suggestions);
                });
            },
            select: function (event, ui) {
                searchForInteractions();
            }
        });

        var onEnter = function (e, ui) {
            if (e.keyCode == 13) {
                searchForInteractions();
            }
        };
        $("#taxonInputField").change(function () {
            searchForInteractions();
        });
        $("#taxonInputField").keyup(onEnter);

        $("#interactionType").change(function () {
            searchForInteractions();
        });
        $("#studySearchField").keyup(onEnter);
    });

    var loadStats = function () {
        globiData.findStats({}, function (stats) {
            var interDiv = document.getElementById('interactions');
            interDiv.innerHTML = '<b>' + stats.totalInteractions + '</b>';
            var tgtTaxa = document.getElementById('distinctTaxa');
            tgtTaxa.innerHTML = '<b>' + stats.totalTaxa + '</b>';
            var studies = document.getElementById('studies');
            studies.innerHTML = '<b>' + stats.numberOfStudies + '</b>';
            var references = document.getElementById('sources');
            references.innerHTML = '<b>' + stats.numberOfDistinctSources + '</b>';
        });
    };



    var init = function () {
        var params = queryString.parse(document.location.search || document.location.hash);
        globiData.currentSelection = { value: params.sourceTaxon, label: params.sourceTaxon, interactionType: params.interactionType };
        $('#interactionType option[value="' + params.interactionType + '"]').prop('selected', 'selected');
        $('#studySearchField').val(params.accordingTo);
        $('#taxonInputField').val(params.sourceTaxon);

        if (params.sourceTaxon || params.accordingTo) {
            $('#taxonInputField').change();
        }
        loadStats();
    };

    window.onpopstate = function(e) {
        init();
    };
</script>
</body>
</html>
