<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Global Biotic Interactions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="MHqp6kVCB-ILE2P_5iHK902nz8mCR0HwnqIgEFvwBgU"/>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="globi.css"/>
</head>
<body onload="init()">
<div class="ui-widget">
    <p>What do
        <input id="taxonInputField" class="suggest" autocomplete="off" placeholder="organisms"/>
        <select id="interactionType">
            <option value="interactsWith">interact with</option>
            <option value="eats">eat</option>
            <option value="eatenBy">get eaten by</option>
            <option value="preysOn">preys on</option>
            <option value="preyedUponBy">get preyed on by</option>
            <option value="parasiteOf">parasitize</option>
            <option value="hasParasite">get parasitized by</option>
            <option value="visitsFlowersOf">visits flowers of</option>
            <option value="flowersVisitedBy">flowers visited by</option>
            <option value="pollinates">pollinate</option>
            <option value="pollinatedBy">get pollinated by</option>
            <option value="pathogenOf">infect</option>
            <option value="hasPathogen">get infected by</option>
            <option value="vectorOf">spread</option>
            <option value="hasVector">get spread by</option>
            <option value="kills">kill</option>
            <option value="killedBy">is killed by</option>
        </select> according to <input id="studySearchField" autocomplete="off" placeholder="any study or source"/>?
    </p>
    <div id="info"></div>
    <table id="result">
    </table>
</div>
<script src="menu.js"></script>
<script>
    buildMenu();
</script>

<script src="static/globi-web-min.js"></script>
<script>
    var $ = globiWeb.globi.jQuery;
    var globiData = globiWeb.globi.globiData;
    var offsetDefault = 0;
    var limitDefault = 15;
</script>

<script src="links.js"></script>
<script src="query-string.js"></script>
<script>
  var className = function (someString) {
    return someString.replace(/\W/g, '_');
  }
$(function () {
    var labelForTaxon = function (taxon) {
        var englishName;
        if (taxon.commonNames) {
            englishName = taxon.commonNames['en'];
        }
        var suggestion = taxon.scientificName;
        if (englishName !== undefined) {
            suggestion = englishName + ' (' + suggestion + ')';
        }
        return suggestion;
    };


    function addSearchInfo(sourceTaxonLabel, sourceTaxonName, studyQuery, nDistinctInteractions) {
        var textElem = document.createElement('p');
        textElem.setAttribute('class', 'interaction searchInfo');
        if (sourceTaxonLabel.length == 0) {
            sourceTaxonLabel = 'organisms';
        }
        var prefix = '<span class="' + className(sourceTaxonName) + '">' + sourceTaxonLabel + '</span> ';
        var message = '... plenty of things';
        if (studyQuery.length > 0) {
            message = message + ' according to ' + studyQuery;
        }
        message = message + '!';
        if (nDistinctInteractions == 0) {
            message = '... nothing ';
            if (studyQuery.length > 0) {
                message = message + ' according to ' + studyQuery + '.';
            } else {
                message = message + ' that we are aware of.';
            }
        }

        textElem.innerHTML = prefix + $('#interactionType :selected').text() + message + '<p>Missing some results? Please <a href="https://github.com/jhpoelen/eol-globi-data/wiki/How-to-Contribute-Data-to-Global-Biotic-Interactions%3F">share your datasets</a>! Have suggestions? <a href="https://github.com/jhpoelen/eol-globi-data/issues/new"> Let us know</a>.</p>';
        document.getElementById('info').appendChild(textElem);
    }

    var searchForInteractions = function (offset) {
        $('thead, #moreButton').remove();
        if (!offset) {
            $('.interaction').remove();
        }
        var sourceTaxonName = $('#taxonInputField').val();
        var sourceTaxonLabel = sourceTaxonName;
        var interactionType = $('#interactionType').find(":selected").val();
        var studyQuery = $('#studySearchField').val();
        var searchHash = {};
        var search = { fields: ['source_taxon_name', 'source_taxon_external_id', 'target_taxon_name', 'target_taxon_external_id', 'interaction_type'] };
        if (sourceTaxonName.length > 0) {
            searchHash.sourceTaxon = sourceTaxonName;
            search.sourceTaxa = [sourceTaxonName];
        }
        if (interactionType.length > 0) {
            searchHash.interactionType = interactionType;
            search.interactionType = interactionType;
        }
        if (studyQuery.length > 0) {
            searchHash.accordingTo = studyQuery;
            search.accordingTo = studyQuery;
        }

        search.limit = limitDefault;
        search.offset = offset || offsetDefault;
        window.history.pushState({}, "", "?" + queryString.stringify(searchHash));
        var callback = function (interactions) {
            var resultFragment = document.createDocumentFragment();
            var distinctExternalIds = {};
            var distinctInteractions = {};
            var nInteractions = 0;
            var nDistinctInteractions = 0;

            interactions.forEach(function (interaction) {
                var citationKey = (interaction.source_taxon_external_id + interaction.interaction_type + interaction.target_taxon_external_id);
                nInteractions += 1;
                if (distinctInteractions[citationKey] === undefined) {
                    var row = document.createElement('tr');
                    row.setAttribute('class', 'interaction');
                    resultFragment.appendChild(row);
                    var td = document.createElement('td');
                    td.setAttribute('class', className(interaction.source_taxon_external_id));
                    td.innerHTML = interaction.source_taxon_name;
                    row.appendChild(td);
                    td = document.createElement('td');
                    var div = document.createElement('div');
                    div.setAttribute('class', className(interaction.interaction_type));
                    div.textContent = interaction.interaction_type;
                    td.appendChild(div);
                    row.appendChild(td);
                    td = document.createElement('td');
                    td.setAttribute('class', className(interaction.target_taxon_external_id));
                    td.innerHTML = interaction.target_taxon_name;
                    row.appendChild(td);

                    td = document.createElement('td');
                    td.setAttribute('class', className(citationKey));
                    row.appendChild(td);
                    distinctExternalIds[interaction.target_taxon_external_id] = interaction.target_taxon_external_id;
                    distinctExternalIds[interaction.source_taxon_external_id] = interaction.source_taxon_external_id;

                    distinctInteractions[citationKey] = interaction;
                    nDistinctInteractions += 1;
                }
            });
            distinctExternalIds[sourceTaxonName] = sourceTaxonName;

            if (nInteractions == limitDefault) {
                var button = document.querySelector('#moreButton');
                if (!button) {
                    button = document.createElement('button');
                    button.setAttribute('id', 'moreButton');
                    button.addEventListener('click', function (event) {
                        searchForInteractions(search.offset + limitDefault);
                    });
                    button.textContent = 'more...';
                }
                resultFragment.appendChild(button);
            }

            var result = document.getElementById('result');
            result.appendChild(resultFragment);

            if (!document.querySelector('.searchInfo')) {
                addSearchInfo(sourceTaxonLabel, sourceTaxonName, studyQuery, nDistinctInteractions);
            }

            var loadImagesAndNames = function (distinctExternalIds) {
                Object.keys(distinctExternalIds).forEach(function (name) {
                    globiData.findTaxonInfo(name, function (taxonInfo) {
                        var label = name;
                        if (taxonInfo.scientificName) {
                            label = taxonInfo.scientificName;
                        }
                        if (taxonInfo.commonName !== null) {
                            label = taxonInfo.commonName + '<br>(' + label + ')';
                        }
                        label = '<td>' + label + ' <span class="taxonLinkShow ' + className(taxonInfo.scientificName) + ' ' + className(name) + '" title="show taxon links" onclick="showTaxonLinks(this)" data-taxon="' + name + '">...</span></td>';
                        if (taxonInfo.infoURL) {
                            var link = '<table><tr><td>';
                            var image = '';
                            if (taxonInfo.thumbnailURL) {
                                image = '<a href="' + taxonInfo.infoURL + '"><img src="' + taxonInfo.thumbnailURL + '"/></a>';
                            }
                            label = link + image + '</td></tr><caption align="bottom">' + label + '</caption></table>';
                        }
                        $('.' + className(name)).html(label);

                        if (sourceTaxonName === name) {
                          var aSelector = '.taxonLinkShow.' + className(sourceTaxonName);
                          var focalTaxonElem = document.querySelector(aSelector);
                          if (focalTaxonElem) {
                            showTaxonLinks(focalTaxonElem);
                          }
                        }
                    });
                        
                  });

            };


            var loadReferences = function (distinctInteractions) {
                Object.keys(distinctInteractions).forEach(function (distinctInteractionKey) {
                    var distinctInteraction = distinctInteractions[distinctInteractionKey];
                    var search = { sourceTaxa: [distinctInteraction.source_taxon_external_id], targetTaxa: [distinctInteraction.target_taxon_external_id], interactionType: distinctInteraction.interaction_type, includeObservations: 'true', exactNameMatchOnly: 'true', fields: ['study_title', 'study_citation', 'study_url', 'study_source_citation'] };
                    globiData.findSpeciesInteractions(search, function (distinctInteractionResults) {
                        distinctInteractionResults.forEach(function (distinctInteractionResult) {
                            var studyId = className(distinctInteractionKey + distinctInteractionResult.study_title);
                            if ($('#' + studyId).length == 0) {
                                var citationElem = document.createElement('li');
                                citationElem.setAttribute('id', studyId);
                                var textElem = document.createElement('b');
                                var study = {
                                    citation: distinctInteractionResult.study_citation,
                                    url: distinctInteractionResult.study_url,
                                    source: distinctInteractionResult.study_source_citation};

                                textElem.textContent = study.citation + ' ';
                                citationElem.appendChild(textElem);
                                appendLinkElem(citationElem, study);
                                var span = document.createElement('span');
                                span.textContent = ' ';
                                citationElem.appendChild(span);
                                appendShowElem(citationElem, study);

                                var sourceElem = document.createElement('span');
                                sourceElem.textContent = ' Provider: ' + study.source;
                                citationElem.appendChild(sourceElem);
                                $('.' + className(distinctInteractionKey)).append(citationElem);
                            }
                        });
                    });
                });
            };
            loadReferences(distinctInteractions);
            loadImagesAndNames(distinctExternalIds);

        };
        globiData.findSpeciesInteractions(search, callback);
    };

    $(".suggest").autocomplete({
        minLength: 3,
        source: function (request, response) {
            globiData.findCloseTaxonMatches(request.term, function (closeMatches) {
                var suggestions = [];
                closeMatches.forEach(function (closeMatch, index) {
                    suggestions[index] = {
                        label: labelForTaxon(closeMatch),
                        value: closeMatch.scientificName
                    };
                });
                response(suggestions);
            });
        },
        select: function (event, ui) {
            searchForInteractions();
        }
    });

    var onEnter = function (e, ui) {
        if (e.keyCode == 13) {
            searchForInteractions();
        }
    };
    $("#taxonInputField").change(function () {
        searchForInteractions();
    });
    $("#taxonInputField").keyup(onEnter);

    $("#interactionType").change(function () {
        searchForInteractions();
    });
    $("#studySearchField").keyup(onEnter);
});

var showTaxonLinks = function (elem) {
    var links = [
        { name: 'Encyclopedia of Life', icon: "http://eol.org/assets/favicon.ico", url: "http://eol.org"}
        ,
        { name: 'World Register of Marine Species', icon: "http://www.marinespecies.org/favicon.ico", url: "http://www.marinespecies.org"}
        ,
        { name: 'National Center for Biotechnology Information', icon: "http://www.ncbi.nlm.nih.gov/favicon.ico", url: "https://www.ncbi.nlm.nih.gov"}
        ,
        { name: 'Global Biodiversity Information Facility', icon: "http://cdn.gbif.org/img/favicon/favicon-32x32.png", url: "http://www.gbif.org"}
        ,
        { name: 'Open Tree of Life', icon: "https://tree.opentreeoflife.org/opentree/static/images/mini-opentree-logo.png", url: "https://tree.opentreeoflife.org"}
        ,
        { name: 'National Biodiversity Network', icon: "https://data.nbn.org.uk/favicon.ico", url: "https://data.nbn.org.uk"}
        ,
        { name: 'Atlas of Living Australia', icon: "http://www.ala.org.au/wp-content/themes/ala-wordpress-theme/img/favicon/favicon-32x32.png", url: "http://www.ala.org.au/" }
        ,
        { name: 'Integrated Taxonomic Information System', icon: "http://www.itis.gov/favicon.ico", url: "http://www.itis.gov/" }
        ,
        { name: 'Interim Register of Marine and Nonmarine Genera', icon: "http://www.cmar.csiro.au/favicon.ico", url: "http://www.cmar.csiro.au" }
    ];

    var startsWith = function(str, substr) {
      return str && substr && str.indexOf(substr) === 0;
    }

    globiData.findTaxonLinks(elem.dataset.taxon, function (urls) {
          if (urls !== null) {
            var taxonLinkForUrl = function(url) {
              var selectedLinks = links.filter(function (link) {
                return startsWith(url, link.url);
              });
              var selectedLink;
              if (selectedLinks.length === 0) {
                selectedLink = { icon: 'img/link.png', url: url, name: url };
              } else {
                selectedLink = { icon: selectedLinks[0].icon, url: url, name: selectedLinks[0].name };
              }
              return selectedLink;
            }

            var taxonLinks = urls
              .filter(function(url) { return startsWith(url, "http://") || startsWith(url, "https://"); })
              .sort()
              .map(function (url) { return taxonLinkForUrl(url); });
            
            var linkToItem = function (link) {
                var item = document.createElement("span");
                var a = document.createElement("a");
                a.setAttribute("target", "_blank");
                a.setAttribute("href", link.url);
                a.setAttribute('title', link.name);
                var image = document.createElement("img");
                image.setAttribute("class", "taxonLinkIcon");
                image.setAttribute("src", link.icon);
                a.appendChild(image);
                item.appendChild(a);
                return item;
            };
            
            var suggestNameLink = function(taxonName, globiRef) {
              var item = document.createElement("span");
              var a = document.createElement("a");
              a.setAttribute("title", "suggest a link for this name");
              a.setAttribute("target", "_blank");
              var params = { title: 'name link suggestion for [' + taxonName +']', body: 'Hi!\nI found a taxon name ```' + taxonName + '``` at a [globi page](' + globiRef + '). After reviewing the data sources and relevant taxonomic tools like the [globalnames resolver](http://resolver.globalnames.org), I think that suggestion below might be helpful.\n\n Thanks!\n\n| name | suggested name | name url reference | notes\n| --- | --- | --- | ---\n| ' + taxonName +' | YOUR SUGGESTED NAME | http://somereference | some notes' };  
              a.setAttribute("href", "https://github.com/globalbioticinteractions/globi-names/issues/new?" + queryString.stringify(params));
              a.textContent = 'suggest link';
              item.appendChild(a);
              return item;
            };

            var items = taxonLinks.map(linkToItem);
            if (items.length === 0) {
              items.push(suggestNameLink(elem.dataset.taxon, window.location.href));
            }
            var td = document.createElement("span");
            td.appendChild(document.createElement("br"));
            td.setAttribute("class", "taxonLinkIcons");
            items.forEach(function (item) {
                td.appendChild(item);
            });

            var aSelector = '.taxonLinkShow.' + className(elem.dataset.taxon);
            var taxonElems = document.querySelectorAll(aSelector);
            for (var i = 0; i < taxonElems.length; i++) {
              taxonElems.item(i).parentNode.appendChild(td.cloneNode(true));
              taxonElems.item(i).parentNode.removeChild(taxonElems.item(i));
            }
        }
    });

}

var init = function () {
    var params = queryString.parse(document.location.search || document.location.hash);
    globiData.currentSelection = { value: params.sourceTaxon, label: params.sourceTaxon, interactionType: params.interactionType };
    $('#interactionType option[value="' + params.interactionType + '"]').prop('selected', 'selected');
    $('#studySearchField').val(params.accordingTo);
    $('#taxonInputField').val(params.sourceTaxon);

    if (params.sourceTaxon || params.accordingTo) {
        $('#taxonInputField').change();
    }
    $('#taxonInputField').focus();
}
</script>
</body>
</html>
