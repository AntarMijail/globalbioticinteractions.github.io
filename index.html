---
layout: default
---
<noscript>JavaScript is off. Please enable JavaScript to view full site.</noscript>
<div class="ui-widget">
    <p class="examples">Example queries: <a href="?sourceTaxon=Enhydra%20lutris&interactionType=eats">What do sea otters (<em>Enhydra
        lutris</em>) eat?</a> or <a href="?sourceTaxon=Apis&interactionType=pollinates">What do honey bees (Apis)
        pollinate?</a></p>

    <p class="question">What do
        <input id="taxonInputField" class="suggest" autocomplete="off" placeholder="organisms"/>
        <select id="interactionType">
            <option value="interactsWith">interact with</option>
            <option value="eats">eat</option>
            <option value="eatenBy">get eaten by</option>
            <option value="preysOn">preys on</option>
            <option value="preyedUponBy">get preyed on by</option>
            <option value="parasiteOf">parasitize</option>
            <option value="hasParasite">get parasitized by</option>
            <option value="visitsFlowersOf">visits flowers of</option>
            <option value="flowersVisitedBy">flowers visited by</option>
            <option value="pollinates">pollinate</option>
            <option value="pollinatedBy">get pollinated by</option>
            <option value="pathogenOf">infect</option>
            <option value="hasPathogen">get infected by</option>
            <option value="vectorOf">spread</option>
            <option value="hasVector">get spread by</option>
            <option value="kills">kill</option>
            <option value="killedBy">is killed by</option>
        </select> according to <input id="studySearchField" autocomplete="off" placeholder="any study or source"/>?
    </p>
    <div id="info" class="summary"></div>
    <table id="result" class="answers">
    </table>
</div>

<script src="/js/globi-web-min.js"></script>
<script>
    var $ = globiWeb.globi.jQuery;
    var globiData = globiWeb.globi.globiData;
    var offsetDefault = 0;
    var limitDefault = 15;
</script>

<script src="/js/links.js"></script>
<script src="/js/query-string.js"></script>
<script>
var className = function (someString) {
    return someString.replace(/\W/g, '_');
}
$(function () {
    var labelForTaxon = function (taxon) {
        var englishName;
        if (taxon.commonNames) {
            englishName = taxon.commonNames['en'];
        }
        var suggestion = taxon.scientificName;
        if (englishName !== undefined) {
            suggestion = englishName + ' (' + suggestion + ')';
        }
        return suggestion;
    };


    function addSearchInfo(sourceTaxonLabel, sourceTaxonName, studyQuery, nDistinctInteractions) {
        var textElem = document.createElement('p');
        textElem.setAttribute('class', 'interaction searchInfo');
        if (sourceTaxonLabel === undefined || sourceTaxonLabel.length == 0) {
            sourceTaxonLabel = 'organisms';
        }
        if (sourceTaxonName === undefined) {
            sourceTaxonName = 'organisms';
        }
        var prefix = '<span class="' + className(sourceTaxonName) + '">' + sourceTaxonLabel + '</span> ';
        var message = '... plenty of things';
        if (studyQuery && studyQuery.length > 0) {
            message = message + ' according to ' + studyQuery;
        }
        message = message + '!';
        if (nDistinctInteractions == 0) {
            message = '... nothing ';
            if (studyQuery && studyQuery.length > 0) {
                message = message + ' according to ' + studyQuery + '.';
            } else {
            message = message + ' that we are aware of. Please make sure to use <a href="https://en.wikipedia.org/wiki/Taxon">scientific taxon names</a> to describe the organism that you are interested in. For instance, instead of searching for "guppy", use <a href="?sourceTaxon=Poecilia%20reticulata"><em>Poecilia reticulata</em></a>.';
            }
        }

        var linkToBrowser = ' Like a different view? <a href="browse/index.html' + document.location.search.replace(/^\?/, '#') + '" target="_blank">Open results</a> in interaction browser.';

        var contribute = '<p>' + $('#interactionType :selected').text() + message + '</p><p>Missing some results? Please <a href="https://github.com/jhpoelen/eol-globi-data/wiki/How-to-Contribute-Data-to-Global-Biotic-Interactions%3F">share your datasets</a>! Have suggestions? <a href="https://github.com/jhpoelen/eol-globi-data/issues/new"> Let us know</a>.';
        textElem.innerHTML = prefix + contribute + linkToBrowser + '</p>';
        document.getElementById('info').appendChild(textElem);
      }

      var sourceTaxonKey = function(interaction) {
        return interaction.source_taxon_external_id;
      }

      var targetTaxonKey = function(interaction) {
        return interaction.target_taxon_external_id;
      }

      var citationKey = function(interaction) {
        return sourceTaxonKey(interaction) + interaction.interaction_type + targetTaxonKey(interaction);
      }

    var searchForInteractions = function (offset) {
        $('thead, #moreButton').remove();
        if (!offset) {
            $('.interaction').remove();
        }

        var searchParams = collectSearchParams($);
        var search = searchParams.search;
        search.fields = ['source_taxon_name', 'source_taxon_external_id', 'target_taxon_name', 'target_taxon_external_id', 'interaction_type'];
        search.limit = limitDefault;
        search.offset = offset || offsetDefault;
        saveSearch(searchParams);
        var callback = function (interactions) {
            var resultFragment = document.createDocumentFragment();
            var distinctExternalIds = {};
            var distinctInteractions = {};
            var nInteractions = 0;
            var nDistinctInteractions = 0;

            interactions.forEach(function (interaction) {
                nInteractions += 1;
                if (distinctInteractions[citationKey(interaction)] === undefined) {
                    var row = document.createElement('tr');
                    row.setAttribute('class', 'interaction');
                    resultFragment.appendChild(row);
                    var td = document.createElement('td');
                    td.setAttribute('class', className(sourceTaxonKey(interaction)));
                    td.innerHTML = interaction.source_taxon_name;
                    row.appendChild(td);
                    td = document.createElement('td');
                    var div = document.createElement('div');
                    div.setAttribute('class', className(interaction.interaction_type));
                    div.textContent = interaction.interaction_type;
                    td.appendChild(div);
                    row.appendChild(td);
                    td = document.createElement('td');
                    td.setAttribute('class', className(targetTaxonKey(interaction)));
                    td.innerHTML = interaction.target_taxon_name;
                    row.appendChild(td);

                    td = document.createElement('td');
                    td.setAttribute('class', className(citationKey(interaction)));
                    row.appendChild(td);
                    distinctExternalIds[targetTaxonKey(interaction)] = interaction.target_taxon_external_id;
                    distinctExternalIds[sourceTaxonKey(interaction)] = interaction.source_taxon_external_id;

                    distinctInteractions[citationKey(interaction)] = interaction;
                    nDistinctInteractions += 1;
                }
            });
            distinctExternalIds[searchParams.searchHash.sourceTaxon] = searchParams.searchHash.sourceTaxon;

            if (nInteractions == limitDefault) {
                var button = document.querySelector('#moreButton');
                if (!button) {
                    button = document.createElement('button');
                    button.setAttribute('id', 'moreButton');
                    button.addEventListener('click', function (event) {
                        searchForInteractions(search.offset + limitDefault);
                    });
                    button.textContent = 'more...';
                }
                resultFragment.appendChild(button);
            }

            var result = document.getElementById('result');
            result.appendChild(resultFragment);

            if (!document.querySelector('.searchInfo')) {
                var sourceTaxon = searchParams.searchHash.sourceTaxon;
                var studyQuery = searchParams.searchHash.accordingTo;
                addSearchInfo(sourceTaxon, sourceTaxon, studyQuery, nDistinctInteractions);
            }

            var loadImagesAndNames = function (distinctExternalIds) {
                Object.keys(distinctExternalIds).forEach(function (externalId) {
                    globiData.findTaxonInfo(externalId, function (taxonInfo) {
                        var label = externalId;
                        if (taxonInfo.scientificName) {
                            label = taxonInfo.scientificName;

                        }
                        if (taxonInfo.commonName !== null) {
                            label = taxonInfo.commonName + '<br>(' + label + ')';
                        }
                        var title = 'Click to find out what ' + label.replace('<br>', ' ') + ' ' + $('#interactionType :selected').text() + '.';
                        var labelSpan = '<span class="taxonFollow" onclick="followTaxon(this)" title="' + title + '" data-taxon-external-id="' + externalId + '" data-taxon-name="' + taxonInfo.scientificName + '">' + label + '</span>';
                        label = '<td>' + labelSpan + ' <span class="taxonLinkShow ' + className(taxonInfo.scientificName) + ' ' + className(externalId) + '" title="show taxon links" onclick="showTaxonLinks(this)" data-taxon-external-id="' + externalId + '" data-taxon-name="' + label + '">...</span></td>';
                        if (taxonInfo.infoURL) {
                            var link = '<table><tr><td>';
                            var image = '';
                            if (taxonInfo.thumbnailURL) {
                                image = '<a href="' + taxonInfo.infoURL + '"><img src="' + taxonInfo.thumbnailURL + '"/></a>';
                            }
                            label = link + image + '</td></tr><caption align="bottom">' + label + '</caption></table>';
                        }
                        $('.' + className(externalId)).html(label);

                        if (searchParams.searchHash.sourceTaxon === externalId) {
                            var aSelector = '.taxonLinkShow.' + className(searchParams.searchHash.sourceTaxon);
                            var focalTaxonElem = document.querySelector(aSelector);
                            if (focalTaxonElem) {
                                showTaxonLinks(focalTaxonElem);
                            }
                        }
                    });

                });

            };


            var loadReferences = function (distinctInteractions) {
                Object.keys(distinctInteractions).forEach(function (distinctInteractionKey) {
                    var distinctInteraction = distinctInteractions[distinctInteractionKey];
                    var search = { sourceTaxa: [distinctInteraction.source_taxon_external_id], targetTaxa: [distinctInteraction.target_taxon_external_id], interactionType: distinctInteraction.interaction_type, includeObservations: 'true', exactNameMatchOnly: 'true', fields: ['study_title', 'study_citation', 'study_url', 'study_source_citation'] };
                    globiData.findSpeciesInteractions(search, function (distinctInteractionResults) {
                        distinctInteractionResults.forEach(function (distinctInteractionResult) {
                            var studyId = className(distinctInteractionKey + distinctInteractionResult.study_title);
                            if ($('#' + studyId).length == 0) {
                                var citationElem = document.createElement('li');
                                citationElem.setAttribute('id', studyId);
                                appendCitationTo(distinctInteractionResult, citationElem);
                                $('.' + className(distinctInteractionKey)).append(citationElem);
                            }
                        });
                    });
                });
            };
            loadReferences(distinctInteractions);
            loadImagesAndNames(distinctExternalIds);

        };
        globiData.findSpeciesInteractions(search, callback);
    };

    $(".suggest").autocomplete({
        minLength: 3,
        source: function (request, response) {
            globiData.findCloseTaxonMatches(request.term, function (closeMatches) {
                var suggestions = [];
                closeMatches.forEach(function (closeMatch, index) {
                    suggestions[index] = {
                        label: labelForTaxon(closeMatch),
                        value: closeMatch.scientificName
                    };
                });
                response(suggestions);
            });
        },
        select: function (event, ui) {
            searchForInteractions();
        }
    });

    var onEnter = function (e, ui) {
        if (e.keyCode == 13) {
            searchForInteractions();
        }
    };
    $("#taxonInputField").change(function () {
        searchForInteractions();
    });
    $("#taxonInputField").keyup(onEnter);

    $("#interactionType").change(function () {
        searchForInteractions();
    });
    $("#studySearchField").keyup(onEnter);
});

var followTaxon = function (elem) {
    var inputField = $('#taxonInputField');
    inputField.val(elem.dataset.taxonName);
    inputField.change();
}

var showTaxonLinks = function (elem) {
    var links = [
        { name: 'Encyclopedia of Life', icon: "http://eol.org/assets/favicon.ico", url: "http://eol.org"}
        ,
	{ name: 'iNaturalist', icon: "http://www.inaturalist.org/favicon.ico", url: "http://inaturalist.org"}
        ,
        { name: 'World Register of Marine Species', icon: "http://www.marinespecies.org/favicon.ico", url: "http://www.marinespecies.org"}
        ,
        { name: 'National Center for Biotechnology Information', icon: "http://www.ncbi.nlm.nih.gov/favicon.ico", url: "https://www.ncbi.nlm.nih.gov"}
        ,
        { name: 'Global Biodiversity Information Facility', icon: "http://cdn.gbif.org/img/favicon/favicon-32x32.png", url: "http://www.gbif.org"}
        ,
        { name: 'Open Tree of Life', icon: "https://tree.opentreeoflife.org/opentree/static/images/mini-opentree-logo.png", url: "https://tree.opentreeoflife.org"}
        ,
        { name: 'National Biodiversity Network', icon: "https://data.nbn.org.uk/favicon.ico", url: "https://data.nbn.org.uk"}
        ,
        { name: 'Atlas of Living Australia', icon: "http://www.ala.org.au/wp-content/themes/ala-wordpress-theme/img/favicon/favicon-32x32.png", url: "http://www.ala.org.au/" }
        ,
        { name: 'SeaLifeBase', icon: "http://sealifebase.org/favicon.ico", url: "http://sealifebase.org" }
        ,
        { name: 'FishBase', icon: "http://fishbase.org/favicon.ico", url: "http://fishbase.org" }
        ,
        { name: 'Integrated Taxonomic Information System', icon: "http://www.itis.gov/favicon.ico", url: "http://www.itis.gov/" }
        ,
        { name: 'Interim Register of Marine and Nonmarine Genera', icon: "http://www.marine.csiro.au/favicon.ico", url: "http://www.marine.csiro.au/" }
    ];

    var startsWith = function (str, substr) {
        return str && substr && str.indexOf(substr) === 0;
    }

    globiData.findTaxonLinks(elem.dataset.taxonExternalId, function (urls) {
        if (urls !== null) {
            var taxonLinkForUrl = function (url) {
                var selectedLinks = links.filter(function (link) {
                    return startsWith(url, link.url);
                });
                var selectedLink;
                if (selectedLinks.length === 0) {
                    selectedLink = { icon: 'assets/link.png', url: url, name: url };
                } else {
                    selectedLink = { icon: selectedLinks[0].icon, url: url, name: selectedLinks[0].name };
                }
                return selectedLink;
            }

            var taxonLinks = urls
                    .filter(function (url) {
                        return startsWith(url, "http://") || startsWith(url, "https://");
                    })
                    .sort()
                    .map(function (url) {
                        return taxonLinkForUrl(url);
                    });

            var linkToItem = function (link) {
                var item = document.createElement("span");
                var a = document.createElement("a");
                a.setAttribute("target", "_blank");
                a.setAttribute("href", link.url);
                a.setAttribute('title', link.name);
                var image = document.createElement("img");
                image.setAttribute("class", "taxonLinkIcon");
                image.setAttribute("src", link.icon);
                a.appendChild(image);
                item.appendChild(a);
                return item;
            };

            var suggestNameLink = function (taxonName, globiRef) {
                var item = document.createElement("span");
                var a = document.createElement("a");
                a.setAttribute("title", "suggest a link for this name");
                a.setAttribute("target", "_blank");
                var params = { title: 'name link suggestion for [' + taxonName + ']', body: 'Hi!\nI found a taxon name ```' + taxonName + '``` at a [globi page](' + globiRef + '). After reviewing the data sources and relevant taxonomic tools like the [globalnames resolver](http://resolver.globalnames.org), I think that suggestion below might be helpful.\n\n Thanks!\n\n| name | suggested name | name url reference | notes\n| --- | --- | --- | ---\n| ' + taxonName + ' | YOUR SUGGESTED NAME | http://somereference | some notes' };
                a.setAttribute("href", "https://github.com/globalbioticinteractions/globi-names/issues/new?" + queryString.stringify(params));
                a.textContent = 'suggest link';
                item.appendChild(a);
                return item;
            };

            var items = taxonLinks.map(linkToItem);
            if (items.length === 0) {
                items.push(suggestNameLink(elem.dataset.taxonName, window.location.href));
            }
            var td = document.createElement("span");
            td.appendChild(document.createElement("br"));
            td.setAttribute("class", "taxonLinkIcons");
            items.forEach(function (item) {
                td.appendChild(item);
            });

            var aSelector = '.taxonLinkShow.' + className(elem.dataset.taxonExternalId);
            var taxonElems = document.querySelectorAll(aSelector);
            for (var i = 0; i < taxonElems.length; i++) {
                taxonElems.item(i).parentNode.appendChild(td.cloneNode(true));
                taxonElems.item(i).parentNode.removeChild(taxonElems.item(i));
            }
        }
    });

};

var init = function () {
    var params = queryString.parse(document.location.search || document.location.hash);
    globiData.currentSelection = { value: params.sourceTaxon, label: params.sourceTaxon, interactionType: params.interactionType };
    $('#interactionType option[value="' + params.interactionType + '"]').prop('selected', 'selected');
    $('#studySearchField').val(params.accordingTo);
    $('#taxonInputField').val(params.sourceTaxon);

    if (params.sourceTaxon || params.accordingTo) {
        $('#taxonInputField').change();
    }
};

window.addEventListener('load', function (e) {
    init();
    window.addEventListener('popstate', function (e) {
        init();
    });
});

</script>
