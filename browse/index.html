<!DOCTYPE html>
<html>
<head>
    <title>Global Biotic Interactions | Browse</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../globi.css"/>
    <link rel="stylesheet" href="../node_modules/globi-search/token-input.css">
    <link rel="stylesheet" href="../node_modules/globi-search/style.css"/>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <style>
        table.interactions-result {
            margin-top: 10px;
            border-collapse: collapse;
            font-size: 11px;
        }

        table.interactions-result .odd {
            background-color: #e7e7e7;
        }

        table.interactions-result .odd {
            background-color: #d7d7d7;
        }

        table.interactions-result td {
            padding: 2px 5px;
        }
    </style>

    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        body, html {
            height: 100%;
            width: 100%;
        }

        body {
            overflow: hidden;
        }
    </style>
</head>
<body>
<script src="../menu.js"></script>
<script>
    buildMenu();
</script>
<script src="../static/globi-web-min.js"></script>
<script>
    var globiData = globiWeb.globi.globiData;
    var Spinner = globiWeb.Spinner;


    function appendSpinner(target) {
        var SpinnerOptions = {
            lines: 13, // The number of lines to draw
            length: 10, // The length of each line
            width: 5, // The line thickness
            radius: 20, // The radius of the inner circle
            corners: 1, // Corner roundness (0..1)
            rotate: 0, // The rotation offset
            direction: 1, // 1: clockwise, -1: counterclockwise
            color: '#a0a0a0', // #rgb or #rrggbb or array of colors
            speed: 1, // Rounds per second
            trail: 60, // Afterglow percentage
            hwaccel: false, // Whether to use hardware acceleration
            className: 'spinner', // The CSS class to assign to the spinner
            zIndex: 2e9 // The z-index (defaults to 2000000000)
        };
        return new Spinner(SpinnerOptions).spin(document.querySelector(target));
    }

    var panels = globiWeb.panels();
    panels.appendTo(document.body);


    var helpHtml = '<div id="welcome">' +
            '<h1>Welcome to the GloBI Interaction Browser!</h1>' +
            '<p>Please click on a marker or select an area to display species interactions!</p>' +
            '<p><a target="_blank" href="http://blog.globalbioticinteractions.org">Learn more about GloBI</a>' +
            '</p></div>';
    document.body.querySelector(panels.topLeftContainer).innerHTML = helpHtml;

    globiWeb.widgets = [
        {factory: globiWeb.hairball, target: panels.bottomLeftContainer},
        {factory: globiWeb.bundle, target: panels.bottomRightContainer},
        {factory: globiWeb.searchResult, target: panels.topLeftContainer}
    ];

    var searchContext = globiWeb.searchContext();
    var dataContext = globiWeb.dataContext(searchContext);
    var search = globiWeb.search({searchContext: searchContext});


    search.appendTo('#taxon-filter');

    searchContext.on('searchcontext:searchparameterchange', function(context) {
        window.location.hash = globiWeb.queryString.encode(searchContext.searchParameters);
        globiWeb.widgets.forEach(function (w) {
            var oldWidgetContainer = document.querySelector(w.target);
            while (oldWidgetContainer.firstChild) {
                oldWidgetContainer.removeChild(oldWidgetContainer.firstChild);
            }
            w.spinner = appendSpinner(w.target);
        });
        appendWidgets();
    });

    searchContext.update(globiWeb.queryString.decode(window.location.hash));

    var treeSpinner, wheelSpinner, bundleSpinner;

    var showAreaInfos = function (element) {
        searchContext.update(JSON.parse(element.dataset.spatialSelection));
    };

    function appendWidgets() {
        globiWeb.widgets.forEach(function (w, index) {
            var panel = document.querySelector(w.target).parentElement;
            var canvasDimension = { height: panel.offsetHeight, width: panel.offsetWidth };
            var widget = w.factory({ searchContext: searchContext, canvasDimension: canvasDimension });
            widget.on('append', function (target) {
                w.spinner.stop();
            });
            widget.appendTo(w.target);
        });
    }

    function appendMap() {
        addMap(panels.topRight);
    }

    function addMap(target) {
        var params = searchParams(window.location.search);
        var spatialSelector = globiWeb.spatialSelector(params);
        spatialSelector.on('change', function(target) {
            searchContext.updateSearchParameter('bbox', target.bbox);
        });
        spatialSelector.appendTo(target);
    }

    function searchParams(urlSearchString) {
        function getUrlParameters(searchString) {
            var query = searchString.substring( 1 ),
                    vars = query.split( "&" ),
                    hash = {};
            for ( var i=0; i < vars.length; i++ ) {
                var pair = vars[ i ].split( "=" );
                hash[ pair[ 0 ] ] = pair[ 1 ]
            }
            return hash;
        }

        var urlParameters = getUrlParameters(urlSearchString);

        var bbox = urlParameters[ 'bbox' ] ? urlParameters[ 'bbox' ].split(',') : false;
        var lat = urlParameters[ 'lat' ] || false;
        var lng = urlParameters[ 'lng' ] || false;
        if (lat && lng) {
            bbox = [];
            bbox[ 0 ] = lng >= 0 ? lng * 0.96 : lng * 1.04;
            bbox[ 1 ] = lat >= 0 ? lat * 0.99 : lat * 1.01;
            bbox[ 2 ] = lng >= 0 ? lng * 1.04 : lng * 0.96;
            bbox[ 3 ] = lat >= 0 ? lat * 1.01 : lat * 0.99;
        }
        return { bbox: bbox, lat: lat, lng: lng};
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?&sensor=false&callback=appendMap"></script>
</body>
</html>
